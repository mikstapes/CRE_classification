---
title: "ALL_ENH_analysis"
author: "Mai Phan (phan@molgen.mpg.de)"
date: "5/25/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load pkgs, warning=FALSE, message=FALSE}
library(here)
library(tidyverse)
library(rtracklayer)
library(bamsignals)
```

## About

Notes & scripts for analysis relating to all ENH, counts, projections, etc. 

## Notes

Colors 

-darker: 254, 199, 1 or #fec701
-lighter: #fed439ff

PC: #709AE1(lighter). #5787db(darker)-87, 135, 219
NC: #97a7b3(lighter). #899ca9(darker)-

## Functions

```{r FUNCTIONS DEF, message=FALSE, warning=FALSE}

#- Helper functions #1: tidy raw IPP output 
tidy_IPP <- function(x) {
    x <- x %>% 
    select(name=X1, ref=X2, coords_direct=X3,coords_djikstra=X4,
           score_direct=X5, score_djikstra=X6,bridges=X15) %>% 
    pivot_longer(cols = starts_with("score"), 
                 names_to = "proj_method", 
                 names_prefix = "score_", 
                 values_to = "distance_score")
  return(x)
  
}

#- Helper functions #2: extend projected point +/- 500bp 
extend_proj <- function(x, window_size) {
  
  x$proj_center <- as.numeric(x$proj_center)
  
  x <- x %>% 
    mutate(offset=window_size,  
           proj_start=proj_center-offset, 
           proj_end=proj_center+offset) %>%
    select(-proj_center)
  
  return(x)
  
}

#-  Main function #1: extract projections by threshold and proj method
get_thresholded_proj_new <- function(x, threshold, proj) {
  
  #- tidy IPP, extract only relevant cols 
  x <- tidy_IPP(x)
  
  # -  get coords of thresholded projs based on input
  if (proj=="djikstra") {
      x <- x %>% 
        filter(proj_method=="djikstra" & distance_score >=threshold) %>%
        select(name, coords_djikstra, proj_method) %>% 
        tidyr::separate(coords_djikstra, into = c("proj_chr", "proj_center"), sep = ":")
  }
  
  else if (proj=="direct") {
      x <- x %>% 
        filter(proj_method=="direct" & distance_score >=threshold) %>%
        select(name, coords_direct, proj_method) %>% 
        tidyr::separate(coords_direct, into = c("proj_chr", "proj_center"), sep = ":")
  }
  
  else if (proj=="both") {
      x <- x %>% 
        filter(distance_score >=threshold) %>%
        select(name, coords_direct, coords_djikstra) %>% 
        pivot_longer(cols = starts_with("coords"), ## this will duplicates rows with both projs
                   names_to = "proj_method", 
                   names_prefix = "coords_", 
                   values_to = "proj_coords") %>% 
        tidyr::separate(proj_coords, into = c("proj_chr", "proj_center"), sep = ":")
  }
  ## Extend projected point +/- 250bp

  x <- extend_proj(x, window_size = 250) %>% 
    select(proj_chr, proj_start, proj_end, name, proj_method) %>% 
    group_by(name) %>% # removes un-projected points and keep only the highest score at each proj/method
    filter(!is.na(proj_chr) & distance_score == max(distance_score))  %>% ungroup()
  
  return(distinct(x))
  
}

#-  Main function #2: Get all projected points as tidy df
get_all_proj <- function(x){
    
  x <- tidy_IPP(x) %>% 
  select(name, coords_direct, coords_djikstra, distance_score) %>% 
  pivot_longer(cols = starts_with("coords"), ## this will duplicates rows with both projs
                   names_to = "proj_method", 
                   names_prefix = "coords_", 
                   values_to = "proj_coords") %>% 
        tidyr::separate(proj_coords, into = c("proj_chr", "proj_center"), sep = ":") 
  
  x <- extend_proj(x, window_size = 250) %>% 
    select(proj_chr, proj_start, proj_end, name, proj_method, distance_score) %>% 
    group_by(name) %>% # removes un-projected points and keep only the highest score at each proj/method
    filter(!is.na(proj_chr) & distance_score == max(distance_score)) %>% ungroup()
  
  return(distinct(x))

}


```

## ENH data wrangling 

- Input: raw ipp output, ENH predictions and liftOver files 

- Output (for each ENH set/species): 
1. BED file for each enh class SC, PC, or NC. 
2. BED file for all projected ENH in the target coords, with colors coded for class
3. BED file for all ENH predictions in original coords, with colors coded for class
4. df for all ENH and all projected ENH
5. RData for all output for more downstream analysis


### Load data & add enh class info
First, load in IPP ENH, ENH, and liftOver ENH (10% re-mapped) as seq-conserved ref

```{r load & tidy chicken ENH file, message=FALSE, warning=FALSE}

enH22 <- read_tsv(here("enhancer_sets", "filtered", "HH22h-enh_set.bed"), 
                col_names = FALSE) %>% select(1:4)
       colnames(enH22) <- c("chr", "start", "end", "name")
       
ipp_enH22_raw <- read_tsv(here("input_data", "IPP", "HH22h-enh_set.proj"), col_names = FALSE)

enH22_liftOver <- read_tsv(here("input_data", "HH22h-enh_set_lifted_mm10.bed"), 
                            col_names = FALSE) %>% 
  select(proj_chr=X1, proj_start = X2, proj_end = X3, name=X4)

```

Subset all IPP projections into groups by threshold and seq-conservation:
```{r ENH classification, chicken}

## load all projected points +/- 250bp as tidy df
enH22_ipp_df <- get_all_proj(ipp_enH22_raw)


## Thresholded direct projection
enH22_dir <- enH22_ipp_df %>% 
  filter(proj_method=="direct", distance_score>=0.99) %>% 
  mutate(enh_class="Sequence-cons(SC)")

## Seq-conserved direct projection, i.e. can be lift-ed Over
enH22_SC <- enH22_dir %>% semi_join(enH22_liftOver , by = "name")


## Projected with IPP, above threshold and not Lift-Over
threshold <- 0.95
enH22_PC <- enH22_ipp_df %>% 
  filter(proj_method !="direct", distance_score>=threshold) %>% 
  left_join(select(enH22_SC, name, proj=proj_chr), by = "name") %>% 
  filter(is.na(proj)) %>% select(-proj) %>% 
  mutate(enh_class="Projected-cons(PC)")

## Get the rest of the projection, take only IPP-projected coords from points below threshold
enH22_NC <- enH22_ipp_df %>% filter(proj_method !="direct") %>% 
  anti_join(enH22_SC, by = "name") %>% 
  anti_join(enH22_PC, by = "name") %>% 
  mutate(enh_class="Non-conserved(NC)")

enH22_projected <- rbind(enH22_SC, enH22_PC, enH22_NC) %>% select(-proj_method)
    #save(enH22_projected, file = here("RData", "enHH22_projected_df_0521.RData"))


```

Same for mouse

```{r Load mouse data}
enH10 <- read_tsv(here("enhancer_sets", "filtered", "e105h-enh_set.bed"), 
                col_names = FALSE) %>% select(1:4)
       colnames(enH10) <- c("chr", "start", "end", "name")
       
ipp_enH10_raw <- read_tsv(here("input_data", "IPP", "E105-enh_set.proj"), col_names = FALSE)

enH10_liftOver <- read_tsv(here("input_data", "e105h-enh_set_lifted_gg6.bed"), 
                            col_names = FALSE) %>% 
  select(proj_chr=X1, proj_start = X2, proj_end = X3, name=X4)

```

```{r  Get mouse ENH}

## load all projected points +/- 250bp as tidy df
enH10_ipp_df <- get_all_proj(ipp_enH10_raw[-c(1:3),])


## Thresholded direct projection
enH10_dir <- enH10_ipp_df %>% 
  filter(proj_method=="direct", distance_score>=0.99) %>% 
  mutate(enh_class="Sequence-cons(SC)")

## Seq-conserved direct projection, i.e. can be lift-ed Over
enH10_SC <- enH10_dir %>% semi_join(enH10_liftOver , by = "name")


## Projected with IPP, above threshold and not Lift-Over
threshold <- 0.95
enH10_PC <- enH10_ipp_df %>% 
  filter(proj_method !="direct", distance_score>=threshold) %>% 
  left_join(select(enH10_SC, name, proj=proj_chr), by = "name") %>% 
  filter(is.na(proj)) %>% select(-proj) %>% 
  mutate(enh_class="Projected-cons(PC)")

## Get the rest of the projection, take only IPP-projected coords from points below threshold
enH10_NC <- enH10_ipp_df %>% filter(proj_method !="direct") %>% 
  anti_join(enH10_SC, by = "name") %>% 
  anti_join(enH10_PC, by = "name") %>% 
  mutate(enh_class="Non-conserved(NC)")

enH10_projected <- rbind(enH10_SC, enH10_PC, enH10_NC) %>% select(-proj_method)
    save(enH10_projected, file = here("RData", "enH10_projected_df_0521.RData"))

```

### Export BED 

1. individual BED files
```{r Export individual BEDs}



all_beds <- list(enH22_SC, enH22_PC, enH22_NC) %>% 
  setNames(c("HH22_ENH_SC", "HH22_ENH_PC", "HH22_ENH_NC"))


lapply(names(all_beds), 
       function(x) export.bed(all_beds[[x]], 
                              here("enhancer_sets", "IPP", "chicken-H22", paste0(x, ".bed"))))


mm_bed <- list(enH10_SC, enH10_PC, enH10_NC) %>% 
  setNames(c("HH10_ENH_SC", "HH10_ENH_PC", "HH10_ENH_NC"))

lapply(names(mm_bed), 
       function(x) export.bed(mm_bed[[x]], 
                              here("enhancer_sets", "IPP", "mm_H10", paste0(x, ".bed"))))

```


2. all projected ENH BED file
```{r Export proj BED}
## Write BED file with proj coords

##Chicken
enH22_projected_bed <- enH22_projected %>% 
  select(-distance_score) %>% 
  mutate(score=0, strand=".", tsrt=proj_start, tend=proj_end,
         color = case_when(enh_class=="Sequence-cons(SC)"  ~ "254,199,1",
                           enh_class=="Projected-cons(PC)"  ~ "87,135,219",
                           enh_class=="Non-conserved(NC)"  ~ "137,156,169")) %>% 
  select(-enh_class)

  write_tsv(enH22_projected_bed, 
            here("enhancer_sets", "IPP", "chicken-H22", "HH22_ENH_proj_ALL.bed"),
            col_names = FALSE)
  
##Mouse
enH10_projected_bed <- enH10_projected %>% 
  select(-distance_score) %>% 
  mutate(score=0, strand=".", tsrt=proj_start, tend=proj_end,
         color = case_when(enh_class=="Sequence-cons(SC)"  ~ "254,199,1",
                           enh_class=="Projected-cons(PC)"  ~ "87,135,219",
                           enh_class=="Non-conserved(NC)"  ~ "137,156,169")) %>% 
  select(-enh_class)

  write_tsv(enH10_projected_bed, 
            here("enhancer_sets", "IPP", "mm_H10", "HH10_ENH_proj_ALL.bed"),
            col_names = FALSE)

```

3. original coord BED file w color codes

```{r Export original BED}

enH22 %>% 
  left_join(select(enH22_projected, name, enh_class), by = "name") %>% 
  mutate(score=0, strand=".", tsrt=start, tend=end,
         color = case_when(enh_class=="Sequence-cons(SC)"  ~ "254,199,1",
                           enh_class=="Projected-cons(PC)"  ~ "87,135,219",
                           enh_class=="Non-conserved(NC)"  ~ "137,156,169",
                           TRUE ~ "137,156,169")) %>% select(-enh_class) %>% 
  write_tsv(here("enhancer_sets", "HH22_ENH.bed"))

enH10 %>% 
  left_join(select(enH10_projected, name, enh_class), by = "name") %>% 
  mutate(score=0, strand=".", tsrt=start, tend=end,
         color = case_when(enh_class=="Sequence-cons(SC)"  ~ "254,199,1",
                           enh_class=="Projected-cons(PC)"  ~ "87,135,219",
                           enh_class=="Non-conserved(NC)"  ~ "137,156,169",
                           TRUE ~ "137,156,169")) %>% select(-enh_class) %>% 
  write_tsv(here("enhancer_sets", "e105h_ENH.bed"))

```


### Get tidy df for ENH with original coords

```{r tidy df for ENH}

enH22_df <- enH22 %>% 
  left_join(select(enH22_projected, name, enh_class), by = "name") %>% 
  mutate(enh_gr = case_when(enh_class=="Sequence-cons(SC)"  ~ "SC",
                           enh_class=="Projected-cons(PC)"  ~ "PC",
                           enh_class=="Non-conserved(NC)"  ~ "NC",
                           TRUE ~ "NC")) %>% select(-enh_class)
enH10_df <- enH10 %>% 
  left_join(select(enH10_projected, name, enh_class), by = "name") %>% 
  mutate(enh_gr = case_when(enh_class=="Sequence-cons(SC)"  ~ "SC",
                           enh_class=="Projected-cons(PC)"  ~ "PC",
                           enh_class=="Non-conserved(NC)"  ~ "NC",
                           TRUE ~ "NC")) %>% select(-enh_class)


save(enH22_df, enH10_df, file = here("RData", "ENH_df.RData"))
save(enH22_projected, enH10_projected, file = here("RData", "ENH_proj_df.RData"))


```



### Write all output to RData






## ENH downstream analysis

1. Replot ENH counts. SC vs all and SC, PC, NC

```{r Stacked bar plots for ENH}

## Loaded wrangled data
load(here("RData", "ENH_df.RData"))
load(here("RData", "ENH_proj_df.RData"))

## Colors scheme for ENH class
ENH_colors_light <- c("#fed439ff", "#709AE1", "#97a7b3")
ENH_colors_dark <- c("#fec701", "#5787db", "#899ca9")

## Plot SC vs all, mm & chicken

enh_m <- enH10_df %>% mutate(stage = "E10.5 Mouse ENH")
enh_g <- enH22_df %>% mutate(stage = "HH22 Mouse ENH")

all_ENH_df <- rbind(enh_m, enh_g)
  rm(enh_m, enh_g)
  

SC_plot <-  all_ENH_df %>% mutate(enh_seq=if_else(enh_gr=="SC", "SC", "NC")) %>% 
  ggplot(aes(fill = factor(enh_seq), stage)) +
  geom_bar(position = "fill", color="#666666") +
  geom_text(stat='count',aes(label=..count..), 
            position = position_fill(vjust = 0.5),
            size = 5) +
  coord_flip() +
  scale_fill_manual(values=ENH_colors_light[c(3,1)]) +
  xlab("") + ylab("") +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_blank()) +
  theme(axis.ticks.y = element_blank()) +
  theme(axis.ticks.length = unit(0.3, "cm")) +
  theme(axis.line.x = element_line(color = "black")) +
  theme(text = element_text(size = 20)) +
  theme(panel.background = element_blank()) +
  theme(legend.position = "bottom") +
  theme(legend.title = element_blank())

ENH_all_plot <- all_ENH_df %>% 
  ggplot(aes(fill = factor(enh_gr), stage)) +
  geom_bar(position = "fill", color="#666666") +
  geom_text(stat='count',aes(label=..count..), 
            position = position_fill(vjust = 0.5),
            size = 5) +
  coord_flip() +
  scale_fill_manual(values=ENH_colors_light[3:1]) +
  xlab("") + ylab("") +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_blank()) +
  theme(axis.ticks.y = element_blank()) +
  theme(axis.ticks.length = unit(0.3, "cm")) +
  theme(axis.line.x = element_line(color = "black")) +
  theme(text = element_text(size = 20)) +
  theme(panel.background = element_blank()) +
  theme(legend.position = "bottom") +
  theme(legend.title = element_blank())

stats_plist<- list(SC_plot, ENH_all_plot) 

pdf(here("plots", "ENH_stats_0521.pdf"))

for (i in 1:2) {
  print(stats_plist[[i]])
}

dev.off()



```






























## TEST CODE

```{r}

test_ipp_raw <- head(ipp_enH22_raw, n = 6)

test_tidy <- get_thresholded_proj(test_ipp, 0.95, "both")

test_df1 <- head(enH22_ipp_df, n = 10)

test_df <- test_df1 %>% 
  mutate(thresholded = if_else(distance_score >= 0.95, "Pass", "Fail")) 


  # mutate(enh_class = case_when(proj_method == "direct" & thresholded == "Pass" ~ "Sequence-cons (SC)",
  # thresholded == "Fail" ~ "Non-cons(NC)"))
  
test_SC <- test_df %>% 
  filter(proj_method=="direct" & thresholded =="Pass") %>% 
  mutate(enh_class="Sequence-cons(SC)")

test_NC <- test_df %>% filter(thresholded =="Fail") %>% mutate(enh_class="Non-conserved(NC)")

test_IPP <- test_df %>% 
  filter(proj_method!="direct" & thresholded =="Pass") %>% left_join(
  select(test_SC, name, proj=proj_chr), by = "name") %>% 
  filter(is.na(proj)) %>%  
  select(-proj) %>% 
  mutate(enh_class="Projected-cons(PC)")

rbind(test_SC, test_IPP, test_NC)
```

